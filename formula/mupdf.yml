summary: Lightweight PDF and XPS viewer
git-url: git://git.ghostscript.com/mupdf.git
got-uri: https://github.com/ArtifexSoftware/mupdf
web-url: https://mupdf.com/
src-url: https://mupdf.com/downloads/archive/mupdf-1.27.0-source.tar.gz
src-sha: ae2442416de499182d37a526c6fa2bacc7a3bed5a888d113ca04844484dfe7c6
license: AGPL-3.0-or-later
dep-pkg: openssl-dev libtesseract libjbig2dec libharfbuzz libgumbo libmujs

res-url: https://mujs.com/downloads/mujs-1.3.8.tar.gz
res-sha: 506d34882f2620a2fdeb6db63dbb7a8ffd98f417689d8f3c84f2feac275e39a9

dopatch: |
    for item in $(find thirdparty -maxdepth 1 -mindepth 1 -type d)
    do
        [ "$item" = thirdparty/extract ] && continue
        [ "$item" = thirdparty/lcms2 ]   && continue
        run rm -rf "$item"
    done

    run ln -s ../../res thirdparty/mujs

    gsed -i 's|USE_ARGUMENT_FILE=yes|USE_ARGUMENT_FILE=no|' Makefile

prepare: |
    unset GMAKE_EXTRA_ARGS

    for KV in FREETYPE:freetype2 HARFBUZZ:harfbuzz TESSERACT:tesseract LEPTONICA:lept OPENJPEG:libopenjp2 LIBJPEG:libjpeg GUMBO:gumbo
    do
        K="${KV%:*}"
        V="${KV#*:}"

        A="$(pkg-config --cflags "$V")"
        B="$(pkg-config --libs   "$V")"

        GMAKE_EXTRA_ARGS="$GMAKE_EXTRA_ARGS HAVE_SYS_${K}=yes SYS_${K}_CFLAGS='$A' SYS_${K}_LIBS='$B'"
    done

install: |
    gmakew clean
    gmakew install-apps install-docs \
        build=$PROFILE \
        shared=no \
        verbose=yes \
        tesseract=yes \
        prefix=$PACKAGE_INSTALL_DIR \
        CC=$CC \
        AR=$AR \
        RANLIB=$RANLIB \
        XCFLAGS="'$CFLAGS $CPPFLAGS'" \
        USE_SYSTEM_LIBS=yes \
        USE_SYSTEM_MUJS=no \
        USE_SYSTEM_LEPTONICA=yes \
        USE_SYSTEM_TESSERACT=yes \
        $GMAKE_EXTRA_ARGS
